#!/usr/bin/env python3
"""
Script d'extraction de fichiers gzip.
Usage: extract [--config-dir CONFIG_DIR] FILE_PATH [SERVER_NAME]
"""
import sys
import argparse
from pathlib import Path

# Ajouter le répertoire src au PYTHONPATH
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root / "src"))

from src.config import load_config
from src.extractor import Extractor
from src.state import StateManager
from src.logger import setup_logger


def main():
    """Point d'entrée pour l'extraction."""
    parser = argparse.ArgumentParser(
        description="Extraction de fichiers gzip"
    )
    parser.add_argument(
        "--config-dir",
        type=Path,
        default=None,
        help="Répertoire contenant les fichiers de configuration",
    )
    parser.add_argument(
        "file_path",
        type=Path,
        help="Chemin du fichier gzip à extraire",
    )
    parser.add_argument(
        "server_name",
        nargs="?",
        help="Nom du serveur source (déduit du chemin si non fourni)",
    )
    
    args = parser.parse_args()
    
    try:
        # Charger la configuration
        config = load_config(args.config_dir)
        
        # Configurer le logger
        logger = setup_logger(config.log, config.log_dir)
        
        # Déterminer le nom du serveur
        server_name = args.server_name
        if not server_name:
            # Essayer de déduire depuis le chemin (chercher incoming/SERVER_NAME/...)
            parts = Path(args.file_path).parts
            if "incoming" in parts:
                idx = parts.index("incoming")
                if idx + 1 < len(parts):
                    server_name = parts[idx + 1]
        
        if not server_name:
            # Utiliser le premier serveur disponible
            if config.servers:
                server_name = config.servers[0].name
            else:
                print("Error: Cannot determine server name. Please provide it explicitly.", file=sys.stderr)
                return 1
        
        # Créer l'extracteur
        state_manager = StateManager(config.state_dir)
        extractor = Extractor(config, state_manager)
        
        # Extraire le fichier
        result = extractor.extract_file(Path(args.file_path), server_name)
        
        if result:
            print(f"File extracted successfully: {result}")
            return 0
        else:
            print(f"Failed to extract file: {args.file_path}", file=sys.stderr)
            return 1
        
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())

